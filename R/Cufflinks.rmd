---
title: "Cufflinks"
author: "Heath O'Brien"
output:
  tufte::tufte_html: default
  #tufte::tufte_handout: default
---
<!-- see http://rstudio.github.io/tufte/ for info about tufte -->
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
rm(list=ls())
library(dplyr)
library(data.table)
library(ggplot2)
library(tidyr)
library(tufte)
library(RColorBrewer)
library(scales)
source("~/BTSync/Code/R/FormatGGplot.R")

```


```{r include=FALSE}
Combined <- fread("~/BTSync/FetalRNAseq/Cufflinks/Combined.tracking", header=FALSE)
AllTranscripts <- ifelse(Combined[,5:ncol(Combined), with=FALSE] == '-', 0, 1)
Combined$Count<- rowSums(AllTranscripts)

```

# Cufflinks
## Transcript saturation (mean of 100 random samples) 
`r margin_note("- 207,000 match reference (=)")`
`r margin_note("- 216,000 intronic (i)")`
`r margin_note("- 77,000 fall in repeat masked regions (r)")`
`r margin_note("- 51,000 multiple classes (.)")`
`r margin_note("- 48,000 intergenic (u)")`
`r margin_note("- 36,000 splice variants (j)")`
`r margin_note("- 32,000 antisense (x)")`
`r margin_note("- 5000 pre-mRNA (e)")`
`r margin_note("- 4000 polymerse run-on (p)")`
`r margin_note("- 1000 generic exon overlap (o)")`
`r margin_note("- 89 contained (c)")`
`r margin_note("- 27 intron antisense (s)")`


```{r pressure, echo=FALSE}
#knitr::kable(
#group_by(Combined, class) %>% summarise(n())
#)
```

`r margin_note("- 'multiple classes' is the only class that shows evidence of saturation")`

``` {r dev.args = list(bg = 'transparent'), warning=FALSE, fig.height=8}
SatData <- read.delim("~/BTSync/FetalRNAseq/Cufflinks/TranscriptSat.txt", header=FALSE)
ggplot(SatData, aes(x=V2, y=V3, colour=V1)) + 
  geom_line() + 
  tufte_theme() +
  theme(legend.position=c(.9,.65)) 
 
```

`r margin_note("- all intergenic features and almost all intron antisense features are singletons")`
`r margin_note("- 'multiple classes' is bimodal, with most being confined to 2 samples or present in all")`

``` {r dev.args = list(bg = 'transparent'), warning=FALSE}
ggplot(Combined, aes(x=Count, fill=class))+geom_bar(position='dodge') +
  facet_grid(class ~ ., scales="free_y") + 
  tufte_theme() +
  scale_y_continuous(breaks=pretty_breaks(n=2), labels=comma)
```

`r margin_note("- Y-axes scaled the same. Most abundant classes excluded")`
``` {r dev.args = list(bg = 'transparent'), warning=FALSE}
ggplot(Combined, aes(x=Count, fill=class))+geom_bar(position='dodge') +
  facet_grid(class ~ .) + 
  scale_y_continuous(limits=c(0,10000), breaks=c(0,5000,10000)) +
  tufte_theme()

```

# Mixed category
`r margin_note("- intronic, repeats, intergenic and antisense are the most common types in the 'multiple types' category")`
`r margin_note("- ca. 300 reference transcripts that overlap an additional feature in another category")`
```{r include=FALSE}
Mixed <- read.delim("~/BTSync/FetalRNAseq/Cufflinks/Mixed.txt", header=FALSE)

colnames(Mixed) <- c('transfrag_id', '=', 'i', 'r', 'u', 'j', 'x', 'e', 'p', 'o', 'c', 's')
summarise_each(Mixed[,-1], funs(sum(.)))
Mixed$total <- rowSums(Mixed[,-1])
Mixed2 <- gather(Mixed, class, count, -transfrag_id, -total)

gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

```

```{r dev.args = list(bg = 'transparent'), warning=FALSE}
ggplot(Mixed2, aes(x=count, fill=class)) +
  geom_bar(position='dodge') +
  facet_grid(class ~ ., scales="free_y") +
  tufte_theme() +
  scale_x_continuous(limits=c(.5,25)) +
  scale_y_continuous(breaks=pretty_breaks(n=2)) +
  scale_fill_manual(values=gg_color_hue(12)[2:12])
```

`r margin_note("- Y-axes scaled the same. Most abundant classes excluded")`
``` {r dev.args = list(bg = 'transparent'), warning=FALSE}
ggplot(Mixed2, aes(x=count, fill=class)) +
  geom_bar(position='dodge') +
  facet_grid(class ~ .) +
  scale_x_continuous(limits=c(.5,25)) +
  scale_y_continuous(limits=c(0,2000), breaks=c(0,1000,2000)) +
  tufte_theme() +
  scale_fill_manual(values=gg_color_hue(12)[2:12])


```
